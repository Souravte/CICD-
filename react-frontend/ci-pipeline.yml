
trigger:
- master

resources:
- repo: self

pool:
  vmImage: ubuntu-latest

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'd6e7b3b6-e634-4138-8e27-3ff952063801'
  imageRepository: 'react-frontend'
  containerRegistry: 'testaksacr9.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'testaksacr91577d987-auth'
  acrPassword: '6lps+e22wxBZWjdIcsg3YQhKvoo+dLpj'
  username: 'testaksacr9'
  aks: 'testaks'
  rg: 'test-aks'

steps:
    # - task: Docker@2
    #   displayName: Build and push an image to container registry
    #   inputs:
    #     containerRegistry: '$(dockerRegistryServiceConnection)'
    #     repository: '$(imageRepository)'
    #     command: 'buildAndPush'
    #     Dockerfile: '**/Dockerfile'
    #     tags: '$(tag)'
    #     addPipelineData: false
    #     addBaseImageData: false
        
    - task: HelmInstaller@0
      inputs:
        helmVersion: '2.14.1'
        installKubectl: true
        
    # - task: HelmDeploy@0
    #   inputs:
    #     command: 'package'
    #     chartPath: 'react-frontend/frontend-chart'
        
    - bash: |
        helm version
        export HELM_EXPERIMENTAL_OCI=1
        cd react-frontend/frontend-chart
        helm chart save . frontend-chart:0.1.0
        helm chart save . $(containerRegistry)/helm/frontend-chart:0.1.0
        echo $(acrPassword) | helm registry login $(containerRegistry) --username $(username) --password-stdin
        helm chart push $(containerRegistry)/helm/frontend-chart:0.1.0

      failOnStderr: true
      name: helmPush
      condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
      displayName: 'Helm push'
      
    - bash: |

        helm repo add testaksacr9 https://testaksacr9.azurecr.io/helm/v1/repo --username testaksacr9 --password 6lps+e22wxBZWjdIcsg3YQhKvoo+dLpj
        helm repo update
      failOnStderr: true
      name: helmCred
      condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
      displayName: 'Helm Cred'
      
    
    - task: HelmDeploy@0
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscription: 'Nipun Bahri Subscription(1)(bf0f6779-86d2-467e-8226-10f92a8ad378)'
        azureResourceGroup: 'test-aks'
        kubernetesCluster: 'testaks'
        namespace: 'default'
        command: 'upgrade'
        chartType: 'Name'
        chartName: 'testaksacr9.azurecr.io/helm/frontend-chart'
        chartVersion: '0.1.0'
    

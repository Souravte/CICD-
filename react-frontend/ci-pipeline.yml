
trigger:
- none

resources:
- repo: self

pool:
  vmImage: ubuntu-latest

parameters:
  - name: projectName
    type: string
    default: react-frontend
  - name: chartName
    type: string
    default: frontend-chart
  - name: appVersion
    type: string
    default: 1.16.0
  - name: chartVersion
    type: string
    default: 1.16.0

variables:
  # Container registry service connection established during pipeline creation
  acrPassword: 'hS=gdMACcSIsx0i5N88iwQrwZmZPRdmu'
  containerRegistry: 'testaks9acr9.azurecr.io'
  acrname: 'testaks9acr9'
  aks: 'testaks9'
  aksrg: 'test-aks'

stages:
- stage: Helm_Build_Deploy
  displayName: Helm Build & Deploy Stage
  jobs:
  - job: Helm
    displayName: Helm Package and Deploy
    pool:
      vmImage: $(vmImage)  
    steps:
        - task: Docker@2
          displayName: 'Build & Push Docker Image to ACR'
          inputs:
            containerRegistry: 'testaks9acr9_sc'
            repository: '${{ parameters.projectName }}'
            command: 'buildAndPush'
            Dockerfile: '${{ parameters.projectName }}/Dockerfile'
            tags: '${{ parameters.appVersion }}'
        
        - task: HelmInstaller@0
          displayName: 'Install Helm'
          inputs:
            helmVersion: '2.14.1'
            installKubectl: true
            
        - task: HelmDeploy@0
          displayName: Save Helm Package to ACR
          inputs:
            azureSubscriptionForACR: 'Nipun Bahri Subscription(bf0f6779-86d2-467e-8226-10f92a8ad378)'
            azureResourceGroupForACR: $(aksrg)
            azureContainerRegistry: $(containerRegistry)
            command: 'save'
            chartNameForACR: ${{ parameters.chartName }}
            chartPathForACR: '${{ parameters.projectName }}/${{ parameters.chartName }}'
          env:
            HELM_EXPERIMENTAL_OCI: 1
            
        - task: AzureCLI@2
          displayName: Download Helm Chart from ACR
          inputs:
            azureSubscription: 'Nipun Bahri Subscription(bf0f6779-86d2-467e-8226-10f92a8ad378)'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az acr login --name $(acrname)
              az acr helm repo add --name $(acrname)
              echo $(acrPassword) | helm registry login $(containerRegistry) --username $(acrname) --password-stdin
              helm repo update
              helm chart pull $(containerRegistry)/helm/${{ parameters.chartName }}:${{ parameters.chartVersion }}
              helm chart export $(containerRegistry)/helm/${{ parameters.chartName }}:${{ parameters.chartVersion }} --destination .
          env:
            HELM_EXPERIMENTAL_OCI: 1

        - task: HelmDeploy@0
          displayName: Helm Package Deployment in AKS
          inputs:
            connectionType: 'Azure Resource Manager'
            azureSubscription: 'Nipun Bahri Subscription(bf0f6779-86d2-467e-8226-10f92a8ad378)'
            azureResourceGroup: $(aksrg)
            kubernetesCluster: $(aks)
            useClusterAdmin: true
            namespace: 'default'
            command: 'upgrade'
            chartType: 'FilePath'
            chartPath: '${{ parameters.projectName }}/${{ parameters.chartName }}'
            releaseName: $(chartVersion)
            arguments: '--create-namespace'
      
    
    
